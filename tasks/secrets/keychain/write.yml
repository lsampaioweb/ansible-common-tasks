---
# Write secret to macOS Keychain using native security command.
# No native Ansible module exists - command module exception approved.
# Required variables:
#   - secret_key: Service name identifier (e.g., "lan.homelab/prd/cert-name")
#   - secret_value: The password/secret to store.
# Behavior:
#   - Stores in current user's default keychain with account name.
#   - Account is set to ansible_facts['user_id'] (current user).
#   - Updates existing entry if present (-U flag for idempotence).
#   - Fails on any error (locked keychain, permission denied, etc.).
# Security note:
#   - Password passed as command argument (brief process list exposure).
#   - This is acceptable given macOS Keychain security command limitations.

- name: "Writing secret to macOS Keychain of user '{{ ansible_facts['user_id'] }}' with key '{{ secret_key }}'"
  no_log: "{{ not debug | default(true) }}"
  ansible.builtin.command:
    cmd: "security add-generic-password -a '{{ ansible_facts['user_id'] }}' -U -s '{{ secret_key }}' -w '{{ secret_value }}'"
  register: "keychain_write_result"
  changed_when: keychain_write_result.rc == 0
  failed_when: keychain_write_result.rc != 0

- name: "Printing Keychain write result"
  when: debug | bool
  ansible.builtin.debug:
    msg: "Successfully wrote secret to Keychain of user '{{ ansible_facts['user_id'] }}' with key '{{ secret_key }}'"
