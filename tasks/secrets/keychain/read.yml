---
# Read secret from macOS Keychain using native security command.
# No native Ansible module exists - command module exception approved.
# Required variables:
#   - secret_key: Service name identifier to retrieve.
# Returns:
#   - secret_value: The retrieved password/secret.
# Behavior:
#   - Searches current user's default keychain by account name.
#   - Account is set to ansible_facts['user_id'] (current user).
#   - Fails if secret not found or keychain locked.
#   - Returns only the password value (no metadata).

- name: "Reading secret from macOS Keychain of user '{{ ansible_facts['user_id'] }}' with key '{{ secret_key }}'"
  no_log: "{{ not debug | default(true) }}"
  ansible.builtin.command:
    cmd: "security find-generic-password -a '{{ ansible_facts['user_id'] }}' -w -s '{{ secret_key }}'"
  register: "keychain_read_result"
  changed_when: false
  failed_when: keychain_read_result.rc != 0

- name: "Setting secret value from Keychain response in variable 'secret_value'"
  no_log: "{{ not debug | default(true) }}"
  ansible.builtin.set_fact:
    secret_value: "{{ keychain_read_result.stdout | trim }}"

- name: "Printing Keychain read result"
  when: debug | bool
  ansible.builtin.debug:
    msg: "Successfully read secret from Keychain of user '{{ ansible_facts['user_id'] }}' with key '{{ secret_key }}'"
