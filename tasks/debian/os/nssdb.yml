---
- name: "Setting path for user's NSS certificate database"
  when: nssdb_path is not defined
  ansible.builtin.set_fact:
    nssdb_path: "{{ lookup('env', 'HOME') }}/.pki/nssdb"

- name: "Checking if the user's NSS database directory exists at {{ nssdb_path }}"
  ansible.builtin.stat:
    path: "{{ nssdb_path }}"
  register: "nssdb_stat"

- name: "Creating the folder {{ nssdb_path }}"
  when: not nssdb_stat.stat.exists
  ansible.builtin.file:
    path: "{{ nssdb_path }}"
    state: "directory"
    recurse: true

- name: "Initializing an empty database at {{ nssdb_path }}"
  when: not nssdb_stat.stat.exists
  ansible.builtin.command: "certutil -N -d sql:{{ nssdb_path }} --empty-password"
  register: "output"
  changed_when: output.rc == 0

- name: "Installing the certificates at {{ nssdb_path }}"
  ansible.builtin.command: >
    certutil -A -d 'sql:{{ nssdb_path }}'
    -t '{{ item.trust }}'
    -n '{{ item.name }}'
    -i '{{ item.path }}'
  loop: '{{ nssdb_certificates | default([]) }}'
  register: "output"
  changed_when: output.rc == 0
  failed_when: (output.rc != 0)
